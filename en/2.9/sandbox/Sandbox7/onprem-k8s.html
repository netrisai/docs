

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run an On-Prem Kubernetes Cluster with Netris Automatic NetOps &mdash; Netris Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/styles.css?v=c10d0aec" />

  
    <link rel="shortcut icon" href="../../_static/netris_favicon.png"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=016f71bc"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffffff" >


  <a href="https://www.netris.ai">



  
  <img src="../../_static/logo-600.png" class="logo" alt="Logo"/>

</a>




<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../concepts.html#introduction-to-netris">Introduction to Netris</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts.html#what-is-netris-controller">What is Netris Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts.html#netris-switch-agent">Netris Switch Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts.html#netris-softgate">Netris SoftGate</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../controller-installation.html">On-prem Netris Controller installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../controller-installation.html#kvm-virtual-machine">KVM virtual machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-installation.html#installation-steps-for-kvm-hypervisor">Installation steps for KVM hypervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-installation.html#netris-controller-installation-steps">Netris Controller Installation steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-installation.html#accessing-the-netris-controller">Accessing the Netris Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-installation.html#security-hardening">Security hardening</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../controller-installation.html#changing-the-default-grpc-authentication-key">Changing the default GRPC authentication key.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-installation.html#replacing-the-ssl-certificate">Replacing the SSL certificate</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../controller-k8s-installation.html">Netris Controller Helm Chart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../controller-k8s-installation.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-k8s-installation.html#get-repo-info">Get Repo Info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-k8s-installation.html#installing-the-chart">Installing the Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-k8s-installation.html#uninstalling-the-chart">Uninstalling the Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-k8s-installation.html#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#common-parameters">Common parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#netris-controller-common-parameters">Netris-Controller common parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#netris-controller-app-parameters">Netris-Controller app parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#netris-controller-grpc-parameters">Netris-Controller grpc parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#netris-controller-telescope-parameters">Netris-Controller telescope parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#netris-controller-k8s-watcher-parameters">Netris-Controller k8s-watcher parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#netris-controller-telescope-notifier-parameters">Netris-Controller telescope-notifier parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#mariadb-parameters">Mariadb parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#mongodb-parameters">Mongodb parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#redis-parameters">Redis parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#smtp-parameters">Smtp parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#haproxy-parameters">HAproxy parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../controller-k8s-installation.html#graphite-parameters">Graphite parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-k8s-installation.html#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../controller-initial-configuration.html">Controller initial configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#definitions">Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#subnets">Subnets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../controller-initial-configuration.html#example-ip-addresses-used-are-just-examples-please-replace-them-following-your-ip-planning">Example:  (IP addresses used are just examples, please replace them following your IP planning.)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#inventory-profiles">Inventory Profiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../controller-initial-configuration.html#fields-descriptions">Fields descriptions:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#adding-switches-to-topology">Adding Switches to Topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#topology-manager">Topology Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#hairpin-cumulus-only">Hairpin (Cumulus only)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../controller-initial-configuration.html#adding-softgate-nodes-to-topology">Adding SoftGate nodes to Topology</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../switch-agent-installation.html">Netris switch agent installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../switch-agent-installation.html#for-cumulus-linux">For Cumulus Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../switch-agent-installation.html#configure-the-oob-management-ip-address">Configure the OOB Management IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../switch-agent-installation.html#configure-cumulus-linux-license">Configure Cumulus Linux license</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../switch-agent-installation.html#install-the-netris-agent">Install the Netris Agent</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../switch-agent-installation.html#for-ubuntu-switchdev">For Ubuntu SwitchDev</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../switch-agent-installation.html#id1">Configure the OOB Management IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../switch-agent-installation.html#id2">Install the Netris Agent</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../SoftGate-agent-installation.html">Netris SoftGate agent installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../SoftGate-agent-installation.html#minimal-hardware-requirements">Minimal hardware requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../SoftGate-agent-installation.html#bios-configuration">BIOS configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../SoftGate-agent-installation.html#software-installation">Software installation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network Policies</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../network-policies.html">Basic BGP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network-policies.html#advanced-bgp">Advanced BGP</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../network-policies.html#bgp-objects">BGP objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../network-policies.html#ipv4-prefix">IPv4 Prefix.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network-policies.html#ipv6-prefix">IPv6 Prefix.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../network-policies.html#community">Community.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../network-policies.html#bgp-route-maps">BGP route-maps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../network-policies.html#routes-static-routing">Routes (static routing)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network-policies.html#nat">NAT</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../network-policies.html#enabling-nat">Enabling NAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network-policies.html#defining-nat-rules">Defining NAT rules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../network-policies.html#looking-glass">Looking Glass</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../services.html">V-NET</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services.html#kubenet">Kubenet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services.html#roh-routing-on-the-host">ROH (Routing on the Host)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services.html#l3-load-balancer-anycast-lb">L3 Load Balancer (Anycast LB)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services.html#l4-load-balancer-l4lb">L4 Load Balancer (L4LB)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../services.html#enabling-l4lb-service">Enabling L4LB service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../services.html#consuming-l4lb-service">Consuming L4LB service</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../services.html#access-control-lists-acl">Access Control Lists (ACL)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../services.html#acl-default-policy">ACL Default Policy.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../services.html#acl-rules">ACL rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../services.html#acl-approval-workflow">ACL approval workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../services.html#the-sequence-order-of-acl-rules">The sequence order of ACL rules</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../visibility.html">Visibility (Telescope)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../visibility.html#graph-boards">Graph Boards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visibility.html#api-logs">API Logs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visibility.html#dashboard">Dashboard</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../accounts.html">Accounts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../accounts.html#users">Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accounts.html#tenants">Tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accounts.html#permission-groups">Permission Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accounts.html#user-roles">User Roles</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Updates</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffffff" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Netris docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <!--
<div class="header-wrapper">
    <div>
        <a class="underscore-transition" href="https://www.netris.ai/overview/">
            Product Overview
        </a>
        <a class="underscore-transition" href="https://www.netris.ai/start/">
            Get started
        </a>
        <a class="underscore-transition" href="https://www.netris.ai/category/blog/">
            Blog
        </a>
    </div>
    <a class="button" href="https://netris.ai/demo">
        Schedule a demo
    </a>
</div>
--><div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Run an On-Prem Kubernetes Cluster with Netris Automatic NetOps</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/netrisai/docs/blob/master/sandbox/Sandbox7/onprem-k8s.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="run-an-on-prem-kubernetes-cluster-with-netris-automatic-netops">
<span id="s7-k8s"></span><h1>Run an On-Prem Kubernetes Cluster with Netris Automatic NetOps<a class="headerlink" href="#run-an-on-prem-kubernetes-cluster-with-netris-automatic-netops" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#intro" id="id1">Intro</a></p></li>
<li><p><a class="reference internal" href="#install-netris-operator" id="id2">Install Netris Operator</a></p></li>
<li><p><a class="reference internal" href="#deploy-an-application-with-an-on-demand-netris-load-balancer" id="id3">Deploy an Application with an On-Demand Netris Load Balancer</a></p></li>
<li><p><a class="reference internal" href="#using-netris-custom-resources" id="id4">Using Netris Custom Resources</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction-to-netris-custom-resources" id="id5">Introduction to Netris Custom Resources</a></p></li>
<li><p><a class="reference internal" href="#l4lb-custom-resource" id="id6">L4LB Custom Resource</a></p></li>
<li><p><a class="reference internal" href="#vnet-custom-resource" id="id7">VNet Custom Resource</a></p></li>
<li><p><a class="reference internal" href="#bgp-custom-resource" id="id8">BGP Custom Resource</a></p></li>
<li><p><a class="reference internal" href="#importing-existing-resources-from-netris-controller-to-kubernetes" id="id9">Importing existing resources from Netris Controller to Kubernetes</a></p></li>
<li><p><a class="reference internal" href="#reclaim-policy" id="id10">Reclaim Policy</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#netris-calico-cni-integration" id="id11">Netris Calico CNI Integration</a></p>
<ul>
<li><p><a class="reference internal" href="#disabling-netris-calico-integration" id="id12">Disabling Netris-Calico Integration</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="intro">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Intro</a><a class="headerlink" href="#intro" title="Link to this heading"></a></h2>
<p>This sandbox environment provides an existing Kubernetes cluster that has been deployed via <a class="reference external" href="https://github.com/kubernetes-sigs/kubespray">Kubespray</a>. For this scenario, we will be using the <a class="reference external" href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ha-mode.md">external LB</a> option in Kubespray. A dedicated Netris L4LB service has been created in each sandbox to access the k8s apiservers from users and non-master nodes sides.</p>
<img alt="../../_images/sandbox-l4lb-kubeapi.png" class="align-center" src="../../_images/sandbox-l4lb-kubeapi.png" />
<p>To access the built-in Kubernetes cluster, put “Kubeconfig” file which you received by the introductory email into your <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code> or set “KUBECONFIG” environment variable <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">KUBECONFIG=~/Downloads/config</span></code> on your local machine. After that try to connect to the k8s cluster:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl cluster-info</span>
</pre></div>
</div>
<p>The output below means you’ve successfully connected to the sandbox cluster:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">Kubernetes master is running at https://api.k8s-sandbox7.netris.ai:6443</span>

<span class="go">To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.</span>
</pre></div>
</div>
</section>
<section id="install-netris-operator">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Install Netris Operator</a><a class="headerlink" href="#install-netris-operator" title="Link to this heading"></a></h2>
<p>The first step to integrate the Netris Controller with the Kubernetes API is to install the Netris Operator. Installation can be accomplished by installing regular manifests or a <a class="reference external" href="https://github.com/netrisai/netris-operator/tree/master/deploy/charts/netris-operator">helm chart</a>.  For this example we will use the Kubernetes regular manifests:</p>
<ol class="arabic simple">
<li><p>Install the latest Netris Operator:</p></li>
</ol>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f https://github.com/netrisai/netris-operator/releases/download/v0.4.7/netris-operator.yaml</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Create credentials secret for Netris Operator:</p></li>
</ol>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -nnetris-operator create secret generic netris-creds \</span>
<span class="go">--from-literal=host=&#39;https://sandbox7.netris.ai/&#39; \</span>
<span class="go">--from-literal=login=&#39;demo&#39; --from-literal=password=&#39;Your Demo user pass&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Inspect the pod logs and make sure the operator is connected to Netris Controller:</p></li>
</ol>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl -nnetris-operator logs -l netris-operator=controller-manager --all-containers -f</span>
</pre></div>
</div>
<p>Example output demonstrating the successful operation of Netris Operator:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1629994653.6441543,&quot;logger&quot;:&quot;controller&quot;,&quot;msg&quot;:&quot;Starting workers&quot;,&quot;reconcilerGroup&quot;:&quot;k8s.netris.ai&quot;,&quot;reconcilerKind&quot;:&quot;L4LB&quot;,&quot;controller&quot;:&quot;l4lb&quot;,&quot;worker count&quot;:1}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After installing the Netris Operator, your Kubernetes cluster and physical network control planes are connected.</p>
</div>
</section>
<section id="deploy-an-application-with-an-on-demand-netris-load-balancer">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Deploy an Application with an On-Demand Netris Load Balancer</a><a class="headerlink" href="#deploy-an-application-with-an-on-demand-netris-load-balancer" title="Link to this heading"></a></h2>
<p>In this scenario we will be installing a simple application that requires a network load balancer:</p>
<p>Install the application <a class="reference external" href="https://github.com/stefanprodan/podinfo">“Podinfo”</a>:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -k github.com/stefanprodan/podinfo/kustomize</span>
</pre></div>
</div>
<p>Get the list of pods and services in the default namespace:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get po,svc</span>
</pre></div>
</div>
<p>As you can see, the service type is “ClusterIP”:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                           READY   STATUS    RESTARTS   AGE</span>
<span class="go">pod/podinfo-576d5bf6bd-7z9jl   1/1     Running   0          49s</span>
<span class="go">pod/podinfo-576d5bf6bd-nhlmh   1/1     Running   0          33s</span>

<span class="go">NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE</span>
<span class="go">service/podinfo      ClusterIP   172.21.65.106   &lt;none&gt;        9898/TCP,9999/TCP   50s</span>
</pre></div>
</div>
<p>In order to request access from outside, change the type to “LoadBalancer”:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl patch svc podinfo -p &#39;{&quot;spec&quot;:{&quot;type&quot;:&quot;LoadBalancer&quot;}}&#39;</span>
</pre></div>
</div>
<p>Check the services again:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get svc</span>
</pre></div>
</div>
<p>Now we can see that the service type changed to LoadBalancer, and “EXTERNAL-IP” switched to pending state:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE</span>
<span class="go">podinfo      LoadBalancer   172.21.65.106   &lt;pending&gt;     9898:32584/TCP,9999:30365/TCP   8m57s</span>
</pre></div>
</div>
<p>Going into the Netris Controller web interface, navigate to <strong>Services / L4 Load Balancer</strong>, and you may see L4LBs provisioning in real-time. If you do not see the provisioning process it is likely because it already completed. Look for the service with the name <strong>“podinfo-xxxxxxxx”</strong></p>
<img alt="../../_images/sandbox-podinfo-prov.png" class="align-center" src="../../_images/sandbox-podinfo-prov.png" />
<p>After provisioning has finished, let’s one more time look at service in k8s:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get svc</span>
</pre></div>
</div>
<p>You can see that “EXTERNAL-IP” has been injected into Kubernetes:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                         AGE</span>
<span class="go">podinfo      LoadBalancer   172.21.65.106   50.117.59.170   9898:32584/TCP,9999:30365/TCP   9m17s</span>
</pre></div>
</div>
<p>Let’s try to curl it (remember to replace the IP below with the IP that has been assigned in the previous command):</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">curl 50.117.59.170:9898</span>
</pre></div>
</div>
<p>The application is now accessible directly on the internet:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w"> </span><span class="nt">&quot;hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;podinfo-576d5bf6bd-nhlmh&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6.0.0&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;#34577c&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;logo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/stefanprodan/podinfo/gh-pages/cuddle_clap.gif&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;greetings from podinfo v6.0.0&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;goos&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linux&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;goarch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;runtime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;go1.16.5&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;num_goroutine&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;num_cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As seen, “PodInfo” developers decided to expose 9898 port for HTTP, let’s switch it to 80:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl patch svc podinfo --type=&#39;json&#39; -p=&#39;[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/spec/ports/0/port&quot;, &quot;value&quot;:80}]&#39;</span>
</pre></div>
</div>
<p>Wait a few seconds, you can see the provisioning process on the controller:</p>
<img alt="../../_images/sandbox-podinfo-ready.png" class="align-center" src="../../_images/sandbox-podinfo-ready.png" />
<p>Curl again, without specifying a port:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">curl 50.117.59.170</span>
</pre></div>
</div>
<p>The output is similar to this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w"> </span><span class="nt">&quot;hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;podinfo-576d5bf6bd-nhlmh&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6.0.0&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;#34577c&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;logo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/stefanprodan/podinfo/gh-pages/cuddle_clap.gif&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;greetings from podinfo v6.0.0&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;goos&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linux&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;goarch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;runtime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;go1.16.5&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;num_goroutine&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;num_cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also verify the application is reachable by putting this IP address directly into your browser.</p>
<aside class="topic">
<p class="topic-title">Milestone 1</p>
<p>Congratulations!  You successfully deployed a network load balancer and exposed an application from your cloud to the internet.  Time to get yourself an iced coffee.</p>
</aside>
</section>
<section id="using-netris-custom-resources">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Using Netris Custom Resources</a><a class="headerlink" href="#using-netris-custom-resources" title="Link to this heading"></a></h2>
<section id="introduction-to-netris-custom-resources">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Introduction to Netris Custom Resources</a><a class="headerlink" href="#introduction-to-netris-custom-resources" title="Link to this heading"></a></h3>
<p>In addition to provisioning on-demand network load balancers, Netris Operator can also provide automatic creation of network services based on Kubernetes CRD objects. Let’s take a look at a few common examples:</p>
</section>
<section id="l4lb-custom-resource">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">L4LB Custom Resource</a><a class="headerlink" href="#l4lb-custom-resource" title="Link to this heading"></a></h3>
<p>In the previous section, when we changed the service type from “ClusterIP” to “LoadBalancer”, Netris Operator detected a new request for a network load balancer, then it created L4LB custom resources. Let’s see them:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get l4lb</span>
</pre></div>
</div>
<p>As you can see, there are two L4LB resources, one for each podinfo’s service port:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                                            STATE    FRONTEND        PORT       SITE     TENANT   STATUS   AGE</span>
<span class="go">podinfo-default-66d44feb-0278-412a-a32d-73afe011f2c6-tcp-80     active   50.117.59.170   80/TCP     US/NYC   Admin    OK       33m</span>
<span class="go">podinfo-default-66d44feb-0278-412a-a32d-73afe011f2c6-tcp-9999   active   50.117.59.170   9999/TCP   US/NYC   Admin    OK       32m</span>
</pre></div>
</div>
<p>You can’t edit/delete them, because Netris Operator will recreate them based on what was originally deployed in the service specifications.</p>
<p>Instead, let’s create a new load balancer using the CRD method.  This method allows us to create L4 load balancers for services outside of what is being created natively with the Kubernetes service schema.  Our new L4LB’s backends will be “srv04-nyc” &amp; “srv05-nyc” on TCP port 80. These servers are already running the Nginx web server, with the hostname present in the index.html file.</p>
<p>Create a yaml file:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">cat &lt;&lt; EOF &gt; srv04-5-nyc-http.yaml</span>
<span class="go">apiVersion: k8s.netris.ai/v1alpha1</span>
<span class="go">kind: L4LB</span>
<span class="go">metadata:</span>
<span class="go"> name: srv04-5-nyc-http</span>
<span class="go">spec:</span>
<span class="go"> ownerTenant: Admin</span>
<span class="go"> site: US/NYC</span>
<span class="go"> state: active</span>
<span class="go"> protocol: tcp</span>
<span class="go"> frontend:</span>
<span class="go">   port: 80</span>
<span class="go"> backend:</span>
<span class="go">   - 192.168.45.64:80</span>
<span class="go">   - 192.168.46.65:80</span>
<span class="go"> check:</span>
<span class="go">   type: tcp</span>
<span class="go">   timeout: 3000</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>And apply it:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f srv04-5-nyc-http.yaml</span>
</pre></div>
</div>
<p>Inspect the new L4LB resources via kubectl:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get l4lb</span>
</pre></div>
</div>
<p>As you can see, provisioning started:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                                            STATE    FRONTEND        PORT       SITE     TENANT   STATUS         AGE</span>
<span class="go">podinfo-default-d07acd0f-51ea-429a-89dd-8e4c1d6d0a86-tcp-80     active   50.117.59.170   80/TCP     US/NYC   Admin    OK             2m17s</span>
<span class="go">podinfo-default-d07acd0f-51ea-429a-89dd-8e4c1d6d0a86-tcp-9999   active   50.117.59.170   9999/TCP   US/NYC   Admin    OK             3m47s</span>
<span class="go">srv04-5-nyc-http                                                active   50.117.59.171   80/TCP     US/NYC   Admin    Provisioning   6s</span>
</pre></div>
</div>
<p>When provisioning is finished, you should be able to connect to L4LB. Try to curl, using the L4LB frontend address displayed in the above command output:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">curl 50.117.59.171</span>
</pre></div>
</div>
<p>You will see the servers’ hostname in curl output:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">SRV04-NYC</span>
</pre></div>
</div>
<p>You can also inspect the L4LB in the Netris Controller web interface:</p>
<img alt="../../_images/sandbox-l4lbs.png" class="align-center" src="../../_images/sandbox-l4lbs.png" />
</section>
<section id="vnet-custom-resource">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">VNet Custom Resource</a><a class="headerlink" href="#vnet-custom-resource" title="Link to this heading"></a></h3>
<p>If you see the same as shown in the previous screenshot, it means you didn’t create “vnet-customer” VNet as stated in the <a class="reference internal" href="creating-services.html#s7-v-net"><span class="std std-ref">“Learn by Creating Services”</span></a> manual. If so, let’s create it from Kubernetes using the VNet custom resource.</p>
<p>Let’s create our VNet manifest:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">cat &lt;&lt; EOF &gt; vnet-customer.yaml</span>
<span class="go">apiVersion: k8s.netris.ai/v1alpha1</span>
<span class="go">kind: VNet</span>
<span class="go">metadata:</span>
<span class="go"> name: vnet-customer</span>
<span class="go">spec:</span>
<span class="go"> ownerTenant: Admin</span>
<span class="go"> guestTenants: []</span>
<span class="go"> sites:</span>
<span class="go">   - name: US/NYC</span>
<span class="go">     gateways:</span>
<span class="go">       - 192.168.46.1/24</span>
<span class="go">     switchPorts:</span>
<span class="go">       - name: swp2@sw22-nyc</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>And apply it:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f vnet-customer.yaml</span>
</pre></div>
</div>
<p>Let’s check our VNet resources in Kubernetes:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get vnet</span>
</pre></div>
</div>
<p>As you can see, provisioning for our new VNet has started:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME            STATE    GATEWAYS          SITES    OWNER   STATUS         AGE</span>
<span class="go">vnet-customer   active   192.168.46.1/24   US/NYC   Admin   Provisioning   7s</span>
</pre></div>
</div>
<p>After provisioning has completed, the L4LB’s checks should work for both backend servers, and incoming requests should be balanced between them.</p>
<p>Let’s curl several times to see that:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">curl 50.117.59.171</span>
</pre></div>
</div>
<p>As we can see, the curl request shows the behavior of “round robin” between the backends:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">SRV05-NYC</span>
<span class="go">curl 50.117.59.171</span>

<span class="go">SRV05-NYC</span>
<span class="go">curl 50.117.59.171</span>

<span class="go">SRV05-NYC</span>
<span class="go">curl 50.117.59.171</span>

<span class="go">SRV04-NYC</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>If intermittently the result of the curl command is “Connection timed out”, it is likely that the request went to the srv05-nyc backend, and the “Default ACL Policy” is set to “Deny”. To remedy this, configure an ACL entry that will allow the srv05-nyc server to communicate external addresses. For step-by-step instruction review the</em> <a class="reference internal" href="creating-services.html#s7-acl"><span class="std std-ref">ACL documentation</span></a>.</p>
</div>
<p>BTW, if you already created “vnet-customer” VNet as stated in the <a class="reference internal" href="creating-services.html#s7-v-net"><span class="std std-ref">“Learn by Creating Services”</span></a>, you may import that to k8s, by adding <code class="docutils literal notranslate"><span class="pre">resource.k8s.netris.ai/import:</span> <span class="pre">&quot;true&quot;</span></code> annotation in VNet manifest, the manifest should look like this:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">cat &lt;&lt; EOF &gt; vnet-customer.yaml</span>
<span class="go">apiVersion: k8s.netris.ai/v1alpha1</span>
<span class="go">kind: VNet</span>
<span class="go">metadata:</span>
<span class="go"> name: vnet-customer</span>
<span class="go"> annotations:</span>
<span class="go">   resource.k8s.netris.ai/import: &quot;true&quot;</span>
<span class="go">spec:</span>
<span class="go"> ownerTenant: Admin</span>
<span class="go"> guestTenants: []</span>
<span class="go"> sites:</span>
<span class="go">   - name: US/NYC</span>
<span class="go">     gateways:</span>
<span class="go">       - 192.168.46.1/24</span>
<span class="go">     switchPorts:</span>
<span class="go">       - name: swp2@sw22-nyc</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>After applying the manifest containing “import” annotation, the VNet, created from the Netris Controller web interface, will appear in k8s and you will be able to manage it from Kubernetes.</p>
</section>
<section id="bgp-custom-resource">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">BGP Custom Resource</a><a class="headerlink" href="#bgp-custom-resource" title="Link to this heading"></a></h3>
<p>Let’s create a new BGP peer, that is listed in the <a class="reference internal" href="creating-services.html#s7-e-bgp"><span class="std std-ref">“Learn by Creating Services”</span></a>.
Create a yaml file:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">cat &lt;&lt; EOF &gt; isp2-customer.yaml</span>
<span class="go">apiVersion: k8s.netris.ai/v1alpha1</span>
<span class="go">kind: BGP</span>
<span class="go">metadata:</span>
<span class="go">  name: isp2-customer</span>
<span class="go">spec:</span>
<span class="go">  site: US/NYC</span>
<span class="go">  softgate: SoftGate2</span>
<span class="go">  neighborAs: 65007</span>
<span class="go">  transport:</span>
<span class="go">    name: swp14@sw02-nyc</span>
<span class="go">    vlanId: 1072</span>
<span class="go">  localIP: 50.117.59.102/30</span>
<span class="go">  remoteIP: 50.117.59.101/30</span>
<span class="go">  description: Example BGP to ISP2</span>
<span class="go">  prefixListOutbound:</span>
<span class="go">    - permit 50.117.59.160/28 le 32</span>
<span class="go">EOF</span>
</pre></div>
</div>
<p>And apply it:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl apply -f isp2-customer.yaml</span>
</pre></div>
</div>
<p>Check created BGP:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get bgp</span>
</pre></div>
</div>
<p>Allow up to 1 minute for both sides of the BGP sessions to come up:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME            STATE     BGP STATE   PORT STATE   NEIGHBOR AS   LOCAL ADDRESS      REMOTE ADDRESS     AGE</span>
<span class="go">isp2-customer   enabled                            65007         50.117.59.102/30   50.117.59.101/30   15s</span>
</pre></div>
</div>
<p>Then check the state again:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get bgp</span>
</pre></div>
</div>
<p>The output is similar to this:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME            STATE     BGP STATE                                      PORT STATE   NEIGHBOR AS   LOCAL ADDRESS      REMOTE ADDRESS     AGE</span>
<span class="go">isp2-customer   enabled   bgp: Established; prefix: 30; time: 00:00:51   UP           65007         50.117.59.102/30   50.117.59.101/30   2m3s</span>
</pre></div>
</div>
<p>Feel free to use the import annotation for this BGP if you created it from the controller web interface previously.</p>
<p>Return to the Netris UI and navigate to <strong>Net / Topology</strong> to see the new BGP neighbor you created.</p>
</section>
<section id="importing-existing-resources-from-netris-controller-to-kubernetes">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Importing existing resources from Netris Controller to Kubernetes</a><a class="headerlink" href="#importing-existing-resources-from-netris-controller-to-kubernetes" title="Link to this heading"></a></h3>
<p>And one more time about importing resources. You can import any custom resources, already created from the Netris Controller to k8s by adding this annotation:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">resource.k8s.netris.ai/import</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</pre></div>
</div>
<p>Otherwise, if try to apply them w/out “import” annotation, the Netris Operator will complain that the resource with such name or specs already exists.</p>
<p>After importing resources to k8s, they will belong to the Netris Operator, and you won’t be able to edit/delete them directly from the Netris Controller web interface, because the Netris Operator will put everything back, as declared in the custom resources.</p>
</section>
<section id="reclaim-policy">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Reclaim Policy</a><a class="headerlink" href="#reclaim-policy" title="Link to this heading"></a></h3>
<p>There is also one useful annotation. So suppose you want to remove some custom resource from k8s, and want to prevent its deletion from the controller, for that you can use “reclaimPolicy” annotation:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">resource.k8s.netris.ai/reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;retain&quot;</span>
</pre></div>
</div>
<p>Just add this annotation in any custom resource while creating it. Or if the custom resource has already been created, change the <code class="docutils literal notranslate"><span class="pre">&quot;delete&quot;</span></code> value to <code class="docutils literal notranslate"><span class="pre">&quot;retain&quot;</span></code> for key <code class="docutils literal notranslate"><span class="pre">resource.k8s.netris.ai/reclaimPolicy</span></code> in the resource annotation. After that, you’ll be able to delete any Netris Custom Resource from Kubernetes, and it won’t be deleted from the controller.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See all options and examples for Netris Custom Resources <a class="reference external" href="https://github.com/netrisai/netris-operator/tree/master/samples">here</a>.</p>
</div>
</section>
</section>
<section id="netris-calico-cni-integration">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Netris Calico CNI Integration</a><a class="headerlink" href="#netris-calico-cni-integration" title="Link to this heading"></a></h2>
<p>Netris Operator can integrate with Calico CNI, in your sandbox k8s cluster, Calico has already been configured as the CNI, so you can try this integration. It will automatically create BGP peering between cluster nodes and the leaf/TOR switch for each node, then to clean up it will disable Calico Node-to-Node mesh. To understand why you need to configure peering between Kubernetes nodes and the leaf/TOR switch, and why you should disable Node-to-Node mesh, review the <a class="reference external" href="https://docs.projectcalico.org/networking/bgp">calico docs</a>.</p>
<p>Integration is very simple, just need to add the annotation in calico’s <code class="docutils literal notranslate"><span class="pre">bgpconfigurations</span></code> custom resource. Before doing that, let’s see the current state of <code class="docutils literal notranslate"><span class="pre">bgpconfigurations</span></code>:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get bgpconfigurations default -o yaml</span>
</pre></div>
</div>
<p>As we can see, <code class="docutils literal notranslate"><span class="pre">nodeToNodeMeshEnabled</span></code> is enabled, and <code class="docutils literal notranslate"><span class="pre">asNumber</span></code> is 64512 (it’s Calico default AS number):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w"> </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w"> </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64512</span>
<span class="w"> </span><span class="nt">logSeverityScreen</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Info</span>
<span class="w"> </span><span class="nt">nodeToNodeMeshEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Let’s enable the “netris-calico” integration:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl annotate bgpconfigurations default manage.k8s.netris.ai/calico=&#39;true&#39;</span>
</pre></div>
</div>
<p>Let’s check our BGP resources in k8s:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get bgp</span>
</pre></div>
</div>
<p>Here are our freshly created BGPs, one for each k8s node:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                STATE     BGP STATE                                      PORT STATE   NEIGHBOR AS   LOCAL ADDRESS      REMOTE ADDRESS      AGE</span>
<span class="go">isp2-customer                       enabled   bgp: Established; prefix: 28; time: 00:06:18   UP           65007         50.117.59.102/30   50.117.59.101/30    7m59s</span>
<span class="go">sandbox7-srv06-nyc-192.168.110.66   enabled                                                               4200070000    192.168.110.1/24   192.168.110.66/24   26s</span>
<span class="go">sandbox7-srv07-nyc-192.168.110.67   enabled                                                               4200070001    192.168.110.1/24   192.168.110.67/24   26s</span>
<span class="go">sandbox7-srv08-nyc-192.168.110.68   enabled                                                               4200070002    192.168.110.1/24   192.168.110.68/24   26s</span>
</pre></div>
</div>
<p>You might notice that peering neighbor AS is different from Calico’s default 64512.  The is because the Netris Operator is setting a particular AS number for each node.</p>
<p>Allow up to 1 minute for the BGP sessions to come up, then check BGP resources again:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get bgp</span>
</pre></div>
</div>
<p>As seen our BGP peers are established:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">NAME                                STATE     BGP STATE                                      PORT STATE   NEIGHBOR AS   LOCAL ADDRESS      REMOTE ADDRESS      AGE</span>
<span class="go">isp2-customer                       enabled   bgp: Established; prefix: 28; time: 00:07:48   UP           65007         50.117.59.102/30   50.117.59.101/30    8m41s</span>
<span class="go">sandbox7-srv06-nyc-192.168.110.66   enabled   bgp: Established; prefix: 5; time: 00:00:44    N/A          4200070000    192.168.110.1/24   192.168.110.66/24   68s</span>
<span class="go">sandbox7-srv07-nyc-192.168.110.67   enabled   bgp: Established; prefix: 5; time: 00:00:19    N/A          4200070001    192.168.110.1/24   192.168.110.67/24   68s</span>
<span class="go">sandbox7-srv08-nyc-192.168.110.68   enabled   bgp: Established; prefix: 5; time: 00:00:44    N/A          4200070002    192.168.110.1/24   192.168.110.68/24   68s</span>
</pre></div>
</div>
<p>Now let’s check if <code class="docutils literal notranslate"><span class="pre">nodeToNodeMeshEnabled</span></code> is still enabled:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl get bgpconfigurations default -o yaml</span>
</pre></div>
</div>
<p>It is disabled, which means the “netris-calico” integration process is finished:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crd.projectcalico.org/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BGPConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">manage.k8s.netris.ai/calico</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">asNumber</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">64512</span>
<span class="w">  </span><span class="nt">nodeToNodeMeshEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Netris Operator won’t disable Node-to-Node mesh until k8s cluster all nodes’ BGP peers are being established.</p>
</div>
<p>Finally, let’s check if our earlier deployed “Podinfo” application is still working when Calico Node-to-Node mesh is disabled:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">curl 50.117.59.170</span>
</pre></div>
</div>
<p>Yes, it works:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w"> </span><span class="nt">&quot;hostname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;podinfo-576d5bf6bd-mfpdt&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6.0.0&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;revision&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;color&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;#34577c&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;logo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/stefanprodan/podinfo/gh-pages/cuddle_clap.gif&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;greetings from podinfo v6.0.0&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;goos&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linux&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;goarch&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;runtime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;go1.16.5&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;num_goroutine&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8&quot;</span><span class="p">,</span>
<span class="w"> </span><span class="nt">&quot;num_cpu&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="disabling-netris-calico-integration">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Disabling Netris-Calico Integration</a><a class="headerlink" href="#disabling-netris-calico-integration" title="Link to this heading"></a></h3>
<p>To disable “Netris-Calico” integration, delete the annotation from Calico’s <code class="docutils literal notranslate"><span class="pre">bgpconfigurations</span></code> resource:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">kubectl annotate bgpconfigurations default manage.k8s.netris.ai/calico-</span>
</pre></div>
</div>
<p>or change its value to <code class="docutils literal notranslate"><span class="pre">&quot;false&quot;</span></code>.</p>
<aside class="topic">
<p class="topic-title">Milestone 2</p>
<p>Congratulations!  You completed Milestone 2.  Time to get yourself another iced coffee or even a beer depending on what time it is!</p>
</aside>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Netris.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Alternate Versions</span>
      v: 2.9
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      
      <dl>
        <dt>Versions</dt>
        
           <strong> 
          <dd><a href="/docs/en/2.9/">2.9</a></dd>
           </strong> 
        
          
          <dd><a href="/docs/en/3.0/">3.0</a></dd>
          
        
          
          <dd><a href="/docs/en/3.4/">3.4</a></dd>
          
        
          
          <dd><a href="/docs/en/4.5.3/">4.5.3</a></dd>
          
        
          
          <dd><a href="/docs/en/4.5.4/">4.5.4</a></dd>
          
        
          
          <dd><a href="/docs/en/latest/">latest</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="/docs/manifests/en/2.9/netris-docs_en_2.9.pdf">pdf</a></dd>
        
          <dd><a href="/docs/manifests/en/2.9/netris-docs_en_2.9.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
      Free theme by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>

<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-152905529-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-152905529-2', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>